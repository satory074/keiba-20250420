# 競馬予測プログラム

このリポジトリには、netkeiba.comとJRA公式サイトからデータを収集・分析し、価値のある馬券を特定する競馬予測プログラムが含まれています。

## 概要

このシステムは、競馬の投資収益率（ROI）110%を達成することを目指した包括的な競馬データ分析・馬券推奨システムです。ユーザーは日本の競馬ウェブサイトnetkeibaとJRA公式サイトから収集された詳細なレースデータを活用して、市場オッズが実際の確率を上回る価値ある馬券を特定できます。

## 新機能: リアルタイムデータ収集・更新パイプライン

最新バージョンでは、以下の機能が追加されました：

- **JRA公式サイトからのデータ収集**: カレンダー情報、出馬表PDF、コース情報などを取得
- **気象庁APIからの天気予報取得**: 競馬場ごとの最新気象情報を取得
- **リアルタイムオッズAPI**: netkeibaの内部APIを使用したリアルタイムオッズ取得
- **スケジューリング機能**: 定期的なデータ更新を自動化（2分〜30分間隔）
- **予測モデルの拡張**: リアルタイムデータを反映した予測の更新
- **データ検証機能の強化**: 不足データの詳細レポート

## 実行手順

### 依存関係のインストール

```bash
pip install requests beautifulsoup4 selenium webdriver-manager tabula-py pdfplumber schedule
```

### 通常モードでのデータ収集

```bash
python main.py <レースID>
```

例：
```bash
python main.py 202505020211
```

これにより、指定されたレースのデータが収集され、`race_data_<レースID>.json`に保存されます。

### リアルタイム更新モードでのデータ収集

```bash
python enhanced_main.py <レースID> --enable-realtime
```

例：
```bash
python enhanced_main.py 202505020211 --enable-realtime
```

リアルタイム更新モードでは、以下のデータが定期的に更新されます：

- **オッズデータ**: 2分ごとに更新
- **気象データ**: 30分ごとに更新
- **馬場状態**: 30分ごとに更新
- **バイアス指標**: レース終了ごとに更新

### 馬券推奨の確認

データ収集後、システムは自動的に馬券推奨を生成します。推奨内容は`betting_recommendation_<レースID>.json`に保存されます。リアルタイム更新モードでは、重要なデータ変更（オッズの15%以上の変動など）があった場合に推奨が自動的に再計算されます。

推奨内容の例：
```json
[
  {
    "bet_type": "tan",
    "horse": "7",
    "horse_name": "ゴーシーファー",
    "odds": 5.8,
    "amount": 1000,
    "expected_value": 1.25,
    "probability": 0.251,
    "reason": "オッズと推定確率の差が大きく、期待値が高い"
  }
]
```

または、賭けない推奨の場合：
```json
[
  {
    "bet_type": "no_bet",
    "reason": "期待値が閾値を超える価値ある馬券が見つかりませんでした",
    "threshold": 1.1
  }
]
```

## システムアーキテクチャ

システムは以下のコンポーネントで構成されています：

1. **情報収集コンポーネント**
   - **netkeiba スクレイパー**: レース情報、馬情報、騎手・調教師情報を収集
   - **JRA公式データ収集**: カレンダー、出馬表PDF、コース情報を取得
   - **気象庁API**: 競馬場ごとの天気予報を取得
   - **オッズAPI**: リアルタイムオッズデータを取得（netkeiba内部APIまたは商用API）

2. **データ処理**
   - **データ検証**: 収集したデータの完全性を検証
   - **データ変換**: 異なるソースからのデータを統合
   - **PDF解析**: JRA出馬表PDFからデータを抽出

3. **スケジューリング**
   - **定期更新**: 設定された間隔でデータを自動更新
   - **変動検知**: 重要な変化（オッズ変動など）を検出
   - **モデル再計算トリガー**: 重要な変化があった場合に予測を再計算

4. **確率推定**
   - **基本モデル**: 静的データに基づく勝率推定
   - **リアルタイムモデル**: 最新データを反映した動的予測
   - **バイアス調整**: 当日のレース傾向に基づく調整

5. **馬券分析と推奨生成**
   - **期待値計算**: オッズと推定確率に基づく期待値計算
   - **馬券種類選択**: 最適な馬券タイプの決定
   - **推奨生成**: 分析に基づく最終的な馬券推奨

### データカテゴリ

システムは以下のカテゴリのデータを収集します：

- **A. レース条件**
  - **A1. 基本情報**: レース名、日時、距離、クラス
  - **A2. コース特性**: コース形状、直線距離、坂の有無
  - **A3. 気象情報**: 天候、気温、風向、風速（気象庁API）
  - **A4. 馬場状態**: 馬場状態、含水率、クッション値
  - **A5. バイアス**: 内外・先行差しの有利不利

- **B. 馬の詳細**
  - **B1. 基本属性**: 馬名、年齢、性別、毛色
  - **B2. 過去成績**: 直近レース結果、同条件での成績
  - **B3. 血統**: 父、母、父父、母父
  - **B4. 調教**: 調教タイム、追い切り評価
  - **B5. 馬の状態**: 休養明け、放牧先
  - **B6. 当日情報**: 馬体重、パドック所見

- **C. 人的要素**
  - **C1. 騎手**: 成績、得意コース、相性
  - **C2. 調教師**: 成績、得意条件、調教センス

- **D. 市場情報**
  - **D1. オッズ**: 単勝・複勝オッズ、オッズ変動
  - **D2. 人気**: 人気順位、支持率
  - **D3. 資金動向**: 馬券種別の資金配分

- **E. 自己分析**
  - **E1. 予測履歴**: 過去の予測と実績の比較
  - **E2. バイアス検出**: 自身の予測バイアスの分析

## フォールバックメカニズム

システムには信頼性の高い運用を確保するための複数のフォールバックメカニズムが含まれています：

1. **データソースの多様化**
   - **netkeiba + JRA**: 両方のソースからデータを収集し相互補完
   - **気象庁API**: 公式の気象データを使用
   - **複数のオッズAPI**: 無料APIと商用APIの両方に対応

2. **キャッシュと更新戦略**
   - **キャッシュデータ**: 利用可能な場合は以前に収集したデータを使用
   - **差分更新**: 完全な再取得ではなく変更部分のみを更新
   - **テストデータ**: ライブスクレイピングが失敗した場合はテストデータにフォールバック

3. **技術的フォールバック**
   - **ヘッドレスブラウザ**: WebDriverの初期化に複数の戦略を使用
   - **PDF解析の冗長性**: 複数のライブラリ（tabula-py, pdfplumber）を使用
   - **API再試行**: 一時的な障害に対する指数バックオフ再試行

## 設定

`config.py`ファイルで以下の設定をカスタマイズできます：

- **更新頻度**: 各データタイプの更新間隔（分）
- **更新閾値**: モデル再計算をトリガーする変動閾値
- **API設定**: 各APIのエンドポイントとパラメータ
- **PDF座標**: JRA PDFからのデータ抽出座標

例：
```python
# 更新頻度設定（分）
UPDATE_FREQUENCY = {
    "weather": 30,         # 気象データ更新頻度
    "track_condition": 30, # 馬場状態更新頻度
    "odds": 2,             # オッズ更新頻度
    "bias": 60             # バイアス指標更新頻度
}

# 更新閾値設定
UPDATE_THRESHOLDS = {
    "odds_change_percent": 15,  # オッズ変動閾値（%）
    "precipitation_change": 20,  # 降水確率変動閾値（%ポイント）
    "moisture_change": 2,        # 含水率変動閾値（%ポイント）
    "cushion_change": 0.5,       # クッション値変動閾値
    "wind_speed_change": 3       # 風速変動閾値（m/s）
}
```

## Seleniumなしでのテスト

Seleniumまたは環境でのChromeに問題がある場合は、`test_non_selenium.py`スクリプトを使用してSeleniumに依存しない部分をテストできます：

```bash
python test_non_selenium.py <レースID>
```

このスクリプトはSeleniumに依存する部分（パドック情報、スピード指数、レースのお知らせ、ライブオッズ）をスキップしますが、基本的なレース情報、馬の詳細、騎手プロフィール、調教師プロフィール、血統データは収集します。

## データ検証

システムには、必要なすべてのデータポイントが収集されていることを確認する検証コンポーネントが含まれています。検証レポートは`validation_report_<レースID>.json`として保存されます。

強化されたデータ検証機能では、以下の改善が行われています：

- **詳細な不足データレポート**: 取得できなかったデータの詳細リスト
- **データソース別の検証**: netkeiba、JRA、気象庁など各ソース別の検証
- **未来レース対応**: 未来レースでは利用可能なデータのみを検証
- **推奨アクション**: 不足データに対する具体的な対処方法の提案

不足データレポートの例：
```
==== 取得できなかったデータの一覧 ====
カテゴリA（レース条件）:
  - 馬場状態: 未来レースのため利用不可
  - 天候: 未来レースのため利用不可

カテゴリB（馬の詳細）:
  - 馬体重: レース当日まで公開されません
  - パドック所見: レース当日まで利用不可

推奨アクション:
  - レース当日に再度データを取得してください
  - 気象庁APIから天気予報を取得するには --enable-realtime オプションを使用してください
====================================
```
